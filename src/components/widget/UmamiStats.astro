---
import WidgetLayout from "./WidgetLayout.astro";
---

<WidgetLayout name="统计" id="umami-stats">
    <div id="umami-stats-container" class="opacity-50 transition-opacity duration-500">
        <div class="text-center mb-4 mt-2">
            <div id="umami-views" class="text-3xl font-bold font-mono text-black dark:text-white mb-1">-</div>
            <div class="text-xs text-black/50 dark:text-white/50">总浏览量</div>
        </div>
        <div class="grid grid-cols-2">
            <div class="text-center border-r border-black/10 dark:border-white/10">
                <div id="umami-visits" class="text-lg font-bold font-mono text-black dark:text-white mb-1">-</div>
                <div class="text-xs text-black/50 dark:text-white/50">访问数</div>
            </div>
            <div class="text-center">
                <div id="umami-visitors" class="text-lg font-bold font-mono text-black dark:text-white mb-1">-</div>
                <div class="text-xs text-black/50 dark:text-white/50">访客数</div>
            </div>
        </div>
    </div>
</WidgetLayout>

<script>
    async function fetchStats() {
        const websiteId = "17ddc2cc-3be4-49eb-9227-fe5e76fbf751";
        const shareId = "nAJfnhzmq9N3yjBe";
        const domain = "https://umami.2407365.xyz";
        const endAt = Date.now();
        const startAt = new Date("2024-01-01").getTime();

        try {
            // 1. 获取 Share Token
            const tokenRes = await fetch(`${domain}/api/share/${shareId}`);
            if (!tokenRes.ok) throw new Error("Failed to get share token");
            const { token } = await tokenRes.json();

            // 2. 获取统计数据
            const response = await fetch(`${domain}/api/websites/${websiteId}/stats?startAt=${startAt}&endAt=${endAt}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "x-umami-share-token": token
                }
            });

            if (response.ok) {
                const data = await response.json();
                const container = document.getElementById("umami-stats-container");
                if (container) container.classList.remove("opacity-50");

                document.getElementById("umami-views").innerText = (data.pageviews.value || data.pageviews || 0).toString();
                document.getElementById("umami-visitors").innerText = (data.visitors.value || data.visitors || 0).toString();
                document.getElementById("umami-visits").innerText = (data.visits.value || data.visits || 0).toString();
            } else {
                console.error("Failed to fetch Umami stats:", response.status);
            }
        } catch (e) {
            console.error("Error fetching Umami stats:", e);
        }
    }

    setTimeout(fetchStats, 1000);
</script>
